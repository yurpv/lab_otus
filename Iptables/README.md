# Iptables
Для лабораторных работ использую Dell amd64, система виртуализации Virtualbox, при выполнении лабораторной работы использовал скаченый образ vagrantbox generic/ubuntu2204.

# Сценарии iptables

### Цель:
### Написать сценарии iptables.

### Описание/Пошаговая инструкция выполнения домашнего задания:</br>
- Что нужно сделать?

1. Реализовать knocking port
2. CentralRouter может попасть на ssh inetrRouter через knock скрипт пример в материалах.
> По настройке knock, воспльзовался данной сатьей https://interface31.ru/tech_it/2021/02/nastraivaem-port-knocking-v-linux-debian-ubuntu.html
4. Добавить inetRouter2, который виден(маршрутизируется (host-only тип сети для виртуалки)) с хоста или форвардится порт через локалхост.
5. Запустить nginx на centralServer.
6. Пробросить 80й порт на inetRouter2 8080.
7. Дефолт в инет оставить через inetRouter

# Выполнения домашнего задания
Для выполения лабораторной работы за основу взял Vagrantfile из домашнего задания Network, удалил office1Router, office1Router, office1Server, office2Server и добавил inetRouter2.
- Запускаем нашу лабораторную командой vagrant up
- Подготовим сервер и настроем knock:
```
root@inetRouter:~# cat /etc/iptables/rules.v4 
# Generated by iptables-save v1.8.7 on Thu Jul  4 04:37:16 2024
*filter
:INPUT DROP [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:TRAFFIC - [0:0]
:SSH-INPUT - [0:0]
:SSH-INPUTTWO - [0:0]
COMMIT
# Completed on Thu Jul  4 04:37:16 2024
# Generated by iptables-save v1.8.7 on Thu Jul  4 04:37:16 2024
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
-A POSTROUTING ! -d 192.168.0.0/16 -o eth0 -j MASQUERADE
COMMIT
# Completed on Thu Jul  4 04:37:16 2024
# TRAFFIC chain for Port Knocking.
-A INPUT -j TRAFFIC
-A SSH-INPUT -m recent --set --name SSH1 --mask 255.255.255.255 --rsource -j DROP
-A SSH-INPUTTWO -m recent --set --name SSH2 --mask 255.255.255.255 --rsource -j DROP
-A TRAFFIC -p icmp -m icmp --icmp-type any -j ACCEPT
-A TRAFFIC -m state --state RELATED,ESTABLISHED -j ACCEPT
-A TRAFFIC -p tcp -m state --state NEW -m tcp --dport 22 -m recent --rcheck --seconds 30 --name SSH2 --mask 255.255.255.255 --rsource -j ACCEPT
-A TRAFFIC -p tcp -m state --state NEW -m tcp -m recent --remove --name SSH2 --mask 255.255.255.255 --rsource -j DROP
-A TRAFFIC -p tcp -m state --state NEW -m tcp --dport 4444 -m recent --rcheck --name SSH1 --mask 255.255.255.255 --rsource -j SSH-INPUTTWO
-A TRAFFIC -p tcp -m state --state NEW -m tcp -m recent --remove --name SSH1 --mask 255.255.255.255 --rsource -j DROP
-A TRAFFIC -p tcp -m state --state NEW -m tcp --dport 3333 -m recent --rcheck --name SSH0 --mask 255.255.255.255 --rsource -j SSH-INPUT
-A TRAFFIC -p tcp -m state --state NEW -m tcp -m recent --remove --name SSH0 --mask 255.255.255.255 --rsource -j DROP
-A TRAFFIC -p tcp -m state --state NEW -m tcp --dport 2222 -m recent --set --name SSH0 --mask 255.255.255.255 --rsource -j DROP
-A TRAFFIC -j DROP
COMMIT
```

- Откроем файл /etc/default/knockd и установим следующую опцию:
```
vi /etc/default/knockd
# control if we start knockd at init or not
# 1 = start
# anything else = don't start
# PLEASE EDIT /etc/knockd.conf BEFORE ENABLING
START_KNOCKD=1

# command line options
#KNOCKD_OPTS="-i eth1"
```

- Затем создадим файл юнита systemd:
```
root@inetRouter:~# vi /etc/systemd/system/knockd.service
cat: 'root@inetRouter:~#': No such file or directory
cat: vi: No such file or directory
[Unit]
Description=Port-Knock Daemon
After=network.target
Requires=network.target
Documentation=man:knockd(1)

[Service]
EnvironmentFile=-/etc/default/knockd
ExecStartPre=/usr/bin/sleep 1
ExecStart=/usr/sbin/knockd $KNOCKD_OPTS
ExecReload=/bin/kill -HUP $MAINPID
KillMode=mixed
Restart=always
SuccessExitStatus=0 2 15
ProtectSystem=full
CapabilityBoundingSet=CAP_NET_RAW CAP_NET_ADMIN

[Install]
WantedBy=multi-user.target
```

- Откроем файл /etc/knockd.conf и удалим оттуда все, кроме первой секции options, которую приведем к следующему виду:
```
root@inetRouter:~# vi /etc/knockd.conf
[options]
        UseSyslog
        Interface = eth1

[opencloseSSH]
        sequence      = 2222:tcp,3333:tcp,4444:tcp
        seq_timeout   = 15
        tcpflags      = syn
        start_command = /sbin/iptables -I INPUT 1 -s %IP% -p tcp --dport 22 -j ACCEPT
        cmd_timeout   = 30
        stop_command  = /sbin/iptables -D INPUT -s %IP% -p tcp --dport ssh -j ACCEPT
```

- Сохраним конфигурацию и запустим сервис:
```
systemctl start knockd
```

- Теперь с сервера centralServer постучимся inetRouter
```
root@centralServer:~# ssh vagrant@192.168.255.1
ssh: connect to host 192.168.255.1 port 22: Connection refused
```

- Как видим - все закрыто, подключиться к серверу невозможно. А теперь стучим:
```
root@centralServer:~# knock 192.168.255.1 2222 3333 4444
```

- Затем, в течение 30 секунд можно будет покдлючиться по ssh с centralRouter на inetRouter
```
root@centralServer:~# ssh vagrant@192.168.255.1
vagrant@192.168.255.1's password: 
Last login: Thu Jul  4 04:53:32 2024 from 192.168.0.2
vagrant@inetRouter:~$ 
```
