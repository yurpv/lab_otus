# Разворачиваем сетевую лабораторию

## Цели домашнего задания

Создать домашнюю сетевую лабораторию. Научится менять базовые сетевые настройки в Linux-based системах.

## Описание домашнего задания

1. Скачать и развернуть [Vagrant-стенд](https://github.com/erlong15/otus-linux/tree/network)

2. Построить следующую сетевую архитектуру:

Сеть office1

- 192.168.2.0/26 - dev
- 192.168.2.64/26 - test servers
- 192.168.2.128/26 - managers
- 192.168.2.192/26 - office hardware

Сеть office2

- 192.168.1.0/25 - dev
- 192.168.1.128/26 - test servers
- 192.168.1.192/26 - office hardware

Сеть central

- 192.168.0.0/28 - directors
- 192.168.0.32/28 - office hardware
- 192.168.0.64/26 - wif

<img width="580" alt="1" src="https://github.com/dimkaspaun/network/assets/156161074/bda42d2d-64ef-443d-b9ee-bbca1cd032a7">


Итого должны получиться следующие сервера:

- inetRouter
- centralRouter
- office1Router
- office2Router
- centralServer
- office1Server
- office2Server

Задание состоит из 2-х частей: теоретической и практической.

В теоретической части требуется:

- Найти свободные подсети
- Посчитать количество узлов в каждой подсети, включая свободные
- Указать Broadcast-адрес для каждой подсети
- Проверить, нет ли ошибок при разбиении

В практической части требуется:

- Соединить офисы в сеть согласно логической схеме и настроить роутинг
- Интернет-трафик со всех серверов должен ходить через inetRouter
- Все сервера должны видеть друг друга (должен проходить ping)
- У всех новых серверов отключить дефолт на NAT (eth0), который vagrant поднимает для связи
- Добавить дополнительные сетевые интерфейсы, если потребуется

Рекомендуется использовать Vagrant + Ansible для настройки данной схемы.

## Пошаговая инструкция выполнения домашнего задания

Все дальнейшие действия были проверены при использовании Vagrant 2.2.19, VirtualBox v6.1.26 r145957. Серьёзные отступления от этой конфигурации могут потребовать адаптации с вашей стороны.

### Теоретическая часть

В теоретической части нам необходимо продумать топологию сети, а также:

- Найти свободные подсети
- Посчитать количество узлов в каждой подсети, включая свободные
- Указать Broadcast-адрес для каждой подсети
- Проверить, нет ли ошибок при разбиении

Первым шагом мы рассмотрим все сети, указанные в задании.

Посчитаем для них количество узлов, найдём Broadcast-адрес, проверим, нет ли ошибок при разбиении.

Расчеты можно выполнить вручную, или воспользоваться калькулятором сетей. Для примера, посчитаем одну подсеть вручную:

У нас есть сеть directors 192.168.0.0/28

192.168.0.0 — это сама сеть, 28 — это маска. Маска показывает нам, границы сети 192.168.0.0. Маска может быть записана в 2-х видах:

1) /28  
2) 255.255.255.240

Пример перевода маски /28 в формат 255.255.255.240:

Маска Ipv4-адреса — это 4 октета, т.е. 4 блока по 8 цифр (1 или 0).  

/28 — это 28 единиц с начала маски: **11111111.11111111.11111111.11110000**

Всегда при разбиении сетей, после знака / указывается количество единиц с начала маски.

**11111111.11111111.11111111.11110000** — это двоичный код маски, если мы переведем данное значение в деситеричную систему счисления, то получим 255.255.255.240

Далее посчитаем количество устройств в сети: Количество устройств в сети рассчитывается по формуле = 2^(32−маска) − 2

Таким образом, количество устройств для подсети /28 будет = 2^(32−28) − 2 = 16 − 2 = 14

Цифра 2 вычитается, так как:

- Первый адрес (192.168.0.0) — это наименование подсети, его нельзя задать устройству
- Последний адрес (192.168.0.15) — это всегда broadcast-адрес.

Broadcast-адрес нужен для рассылки всем устройствам сети.

Таким образом мы можем сформировать таблицу топологии нашей сети

| Сеть | Маска | Кол-во адресов | Первый адрес в сети | Последний адрес в сети | Broadcast адрес |
| --- | --- | --- | --- | --- | --- |
| 192.168.0.0/28 | 255.255.255.240 | 14 | 192.168.0.1 | 192.168.0.14 | 192.168.0.15 |

По такому примеру нужно рассчитать остальные сети. Для проверки себя можно использовать калькулятор масок, например этот - <https://ip-calculator.ru/>

Для того, чтобы получить всю информацию по сети, потребуется указать ip-адрес и маску, например:

![2](https://github.com/dimkaspaun/network/assets/156161074/69bdf059-4a83-4a6c-a2cb-fdd8f48626e3)


После расчета всех сетей, мы должны получить следующую таблицу топологии

| Name | Network | Netmask | N | Hostmin | Hostmax | Broadcast |
| ---  | --- | --- | --- | --- | --- | --- |
| Central Network |
| Directors | 192.168.0.0/28 | 255.255.255.240 | 14 | 192.168.0.1 | 192.168.0.14 | 192.168.0.15 |
| Office hardware | 192.168.0.32/28 | 255.255.255.240 | 14 | 192.168.0.33 | 192.168.0.46 | 192.168.0.47 |
| Wifi (mgt network) | 192.168.0.64/26 | 255.255.255.192 | 62 | 192.168.0.65 | 192.168.0.126 | 192.168.0.127 |
| Office 1 network |
| Dev | 192.168.2.0/26 | 255.255.255.192 | 62 | 192.168.2.1 | 192.168.2.62 | 192.168.2.63 |
| Test | 192.168.2.64/26 | 255.255.255.192 | 62 | 192.168.2.65 | 192.168.2.126 | 192.168.2.127 |
| Managers | 192.168.2.128/26 | 255.255.255.192 | 62 | 192.168.2.129 | 192.168.2.190 | 192.168.2.191 |
| Office hardware | 192.168.2.192/26 | 255.255.255.192 | 62 | 192.168.2.193 | 192.168.2.254 | 192.168.2.255 |
| Office 2 network |
| Dev | 192.168.1.0/25 | 255.255.255.128 | 126 | 192.168.1.1 | 192.168.1.126 | 192.168.1.127 |
| Test | 192.168.1.128/26 | 255.255.255.192 | 62 | 192.168.1.129 | 192.168.1.190 | 192.168.1.191 |
| Ofiice | 192.168.1.192/26 | 255.255.255.192 | 62 | 192.168.1.193 | 192.168.1.254 | 192.168.1.255 |
| InetRouter - CentralRouter network |
| Inet - central | 192.168.255.0/30 | 255.255.255.252 | 2 | 192.168.255.1 | 192.168.255.2 | 192.168.255.3 |

После создания таблицы топологии, мы можем заметить, что ошибок в задании нет, также мы сразу видим следующие свободные сети:

192.168.0.16/28  
192.168.0.48/28  
192.168.0.128/25  
192.168.255.64/26  
192.168.255.32/27  
192.168.255.16/28  
192.168.255.8/29  
192.168.255.4/30  

На этом теоретическая часть заканчивается. Можем приступать к выполнению практической части.

### Практическая часть

Изучив таблицу топологии сети и Vagrant-стенд из задания, мы можем построить полную схему сети:

![image](https://github.com/yurpv/lab_otus/assets/162872411/50526634-2923-49ef-aae1-b072f5950385)



Давайте рассмотрим схему:

Знак облака означает сеть, которую необходимо будет настроить на сервере

Значки роутеров и серверов означают хосты, которые нам нужно будет создать.

На схеме, мы сразу можем увидеть, что нам потребуется создать дополнительно 2 сети (на схеме обозначены полужирными фиолетовыми линиями):

Для соединения office1Router c centralRouter — 192.168.255.8/30  
Для соединения office2Router c centralRouter — 192.168.255.4/30

На основании этой схемы мы получаем готовый список серверов. Для более подробного изучения, сделаем новые хосты с другими ОС.

| Server | IP and Bitmask | OS |
| --- | --- | --- |
| inetRouter | Default-NAT address VirtualBox 192.168.255.1/30 | Ubuntu 22.04 |
| centralRouter | 192.168.255.2/30 |Ubuntu 22.04 |
|| 192.168.0.1/28 ||
|| 192.168.0.33/28 ||
|| 192.168.0.65/26 ||
|| 192.168.255.9/30 ||
|| 192.168.255.5/30 ||
| centralServer | 192.168.0.2/28 | Ubuntu 22.04 |
| office1Router | 192.168.255.10/30 | Ubuntu 22.04 |
|| 192.168.2.1/26 ||
|| 192.168.2.65/26 ||
|| 192.168.2.129/26 ||
|| 192.168.2.193/26 ||
| office1Server | 192.168.2.130/26 | Ubuntu 22.04 |
| office2Router | 192.168.255.6/30 | Ubuntu 22.04 |
|| 192.168.1.1/25 ||
|| 192.168.1.129/26 ||
|| 192.168.1.193/26 ||
| office2Server | 192.168.1.2/25 | Ubuntu 22.04 |

Рекомендация:

При выполнении дальнейших действий, постоянно пользуйтесь схемой, она поможет быстрее понять некоторые моменты руководства.

Скачаем Vagrantfile из [репозитория](https://github.com/erlong15/otus-linux/tree/network)

В полученном vagrant file в :box_name меняем образы CentOS на образы ubuntu 22.04 и добавляем оставшиеся хосты. Также нужно удалить все команды, выполняемые на хостах: 

```
ENV['VAGRANT_SERVER_URL'] = 'https://vagrant.elab.pro'

MACHINES = {
  :inetRouter => {
        :box_name => "generic/ubuntu2204",
        :vm_name => "inetRouter",
        #:public => {:ip => "10.10.10.1", :adapter => 1},
        :net => [
                    #ip, adpter, netmask, virtualbox__intnet
                    ["192.168.255.1", 2, "255.255.255.252",  "router-net"],
                    ["192.168.50.10", 8, "255.255.255.0"],
                ]
  },

  :centralRouter => {
        :box_name => "generic/ubuntu2204",
        :vm_name => "centralRouter",
        :net => [
                   ["192.168.255.2",  2, "255.255.255.252",  "router-net"],
                   ["192.168.0.1",    3, "255.255.255.240",  "dir-net"],
                   ["192.168.0.33",   4, "255.255.255.240",  "hw-net"],
                   ["192.168.0.65",   5, "255.255.255.192",  "mgt-net"],
                   ["192.168.255.9",  6, "255.255.255.252",  "office1-central"],
                   ["192.168.255.5",  7, "255.255.255.252",  "office2-central"],
                   ["192.168.50.11",  8, "255.255.255.0"],
                ]
  },

  :centralServer => {
        :box_name => "generic/ubuntu2204",
        :vm_name => "centralServer",
        :net => [
                   ["192.168.0.2",    2, "255.255.255.240",  "dir-net"],
                   ["192.168.50.12",  8, "255.255.255.0"],
                ]
  },

  :office1Router => {
        :box_name => "generic/ubuntu2204",
        :vm_name => "office1Router",
        :net => [
                   ["192.168.255.10",  2,  "255.255.255.252",  "office1-central"],
                   ["192.168.2.1",     3,  "255.255.255.192",  "dev1-net"],
                   ["192.168.2.65",    4,  "255.255.255.192",  "test1-net"],
                   ["192.168.2.129",   5,  "255.255.255.192",  "managers-net"],
                   ["192.168.2.193",   6,  "255.255.255.192",  "office1-net"],
                   ["192.168.50.20",   8,  "255.255.255.0"],
                ]
  },

  :office1Server => {
        :box_name => "generic/ubuntu2204",
        :vm_name => "office1Server",
        :net => [
                   ["192.168.2.130",  2,  "255.255.255.192",  "managers-net"],
                   ["192.168.50.21",  8,  "255.255.255.0"],
                ]
  },

  :office2Router => {
       :box_name => "generic/ubuntu2204",
       :vm_name => "office2Router",
       :net => [
                   ["192.168.255.6",  2,  "255.255.255.252",  "office2-central"],
                   ["192.168.1.1",    3,  "255.255.255.128",  "dev2-net"],
                   ["192.168.1.129",  4,  "255.255.255.192",  "test2-net"],
                   ["192.168.1.193",  5,  "255.255.255.192",  "office2-net"],
                   ["192.168.50.30",  8,  "255.255.255.0"],
               ]
  },

  :office2Server => {
       :box_name => "generic/ubuntu2204",
       :vm_name => "office2Server",
       :net => [
                  ["192.168.1.2",    2,  "255.255.255.128",  "dev2-net"],
                  ["192.168.50.31",  8,  "255.255.255.0"],
               ]
  }
}

Vagrant.configure("2") do |config|
  MACHINES.each do |boxname, boxconfig|
    config.vm.define boxname do |box|
      box.vm.box = boxconfig[:box_name]
      box.vm.host_name = boxconfig[:vm_name]

      box.vm.provider "virtualbox" do |v|
        v.memory = 768
        v.cpus = 1
       end

      boxconfig[:net].each do |ipconf|
        box.vm.network("private_network", ip: ipconf[0], adapter: ipconf[1], netmask: ipconf[2], virtualbox__intnet: ipconf[3])
      end

      if boxconfig.key?(:public)
        box.vm.network "public_network", boxconfig[:public]
      end

      box.vm.provision "shell", inline: <<-SHELL
        mkdir -p ~root/.ssh
        cp ~vagrant/.ssh/auth* ~root/.ssh
        sudo apt update && apt upgrade -y
        sudo apt install traceroute -y
      SHELL
    end
  end
end
```

В данный Vagrantfile мы добавили информацию о 4 новых серверах, также к старым серверам добавили 2 интерфейса для соединения сетей офисов (в коде выделены полужирным)

Дополнительно в коде вы видите сетевые устройства из подсети 192.168.50.0/24 — они не обязательны и потребуются, если вы планируете настраивать хосты с помощью Ansible.

После того, как все 7 серверов у нас развернуты, нам нужно настроить маршрутизацию и NAT таким образом, чтобы доступ в Интернет со всех хостов был через inetRouter и каждый сервер должен быть доступен с любого из 7 хостов.

Часть настройки у нас уже выполнена, давайте рассмотрим подробнее команды из Vagrantfile.

#### Настройка NAT

Для того, чтобы на всех серверах работал интернет, на сервере inetRouter должен быть настроен NAT. В нашем Vagrantfile он настраивается с помощью команды:

```
iptables -t nat -A POSTROUTING ! -d 192.168.0.0/16 -o eth0 -j MASQUERADE
```

При настройке NAT таким образом, правило удаляется после перезагрузки сервера. Для того, чтобы правила применялись после перезагрузки, в CentOS 7 нужно выполнить следующие действия:

- Подключиться по SSH к хосту: vagrant ssh inetRouter
- Проверить, что отключен другой файервол: systemctl status ufw

```
root@inetRouter:~# systemctl status ufw
● ufw.service - Uncomplicated firewall
     Loaded: loaded (/lib/systemd/system/ufw.service; enabled; vendor preset: enabled)
     Active: active (exited) since Thu 2024-06-27 12:58:30 UTC; 33min ago
       Docs: man:ufw(8)
   Main PID: 414 (code=exited, status=0/SUCCESS)
        CPU: 644us
```

Если служба будет запущена, то нужно её отключить и удалить из автозагрузки:

```
systemctl stop ufw
systemctl disable ufw
Synchronizing state of ufw.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install disable ufw
Removed /etc/systemd/system/multi-user.target.wants/ufw.service.
```

-  Для автоматического сохранения правил iptables, с помощью Ansible установлен iptables-persistent и импортрованы правила, проверим iptables-save:

```
root@inetRouter:~# iptables-save 
root@inetRouter:~# iptables-save
# Generated by iptables-save v1.8.7 on Sat Jun 29 20:46:51 2024
*filter
:INPUT ACCEPT [2932:575621]
:FORWARD ACCEPT [2180:1642830]
:OUTPUT ACCEPT [2154:189038]
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
COMMIT
# Completed on Sat Jun 29 20:46:51 2024
# Generated by iptables-save v1.8.7 on Sat Jun 29 20:46:51 2024
*nat
:PREROUTING ACCEPT [736:75807]
:INPUT ACCEPT [3:212]
:OUTPUT ACCEPT [297:27471]
:POSTROUTING ACCEPT [19:1502]
-A POSTROUTING ! -d 192.168.0.0/16 -o eth0 -j MASQUERADE
COMMIT
# Completed on Sat Jun 29 20:46:51 2024
```

> Если просто запустить команду iptables-save, то на экране консоли появится полный список всех правил, которые действуют на текущий момент. Данная команда очень удобна для поиска проблем в iptables

#### Настройка NAT через Ansible

Выполним идентичные действия с помощью Ansible, для этого в playbook добавим следующие команды:

```
- name: Install IPtables-persistent
      apt:
        name:
          - iptables-persistent
        update_cache: yes
        state: present
      when: (ansible_hostname == "inetRouter")

 - name: Set up NAT on hosts
    template: 
      src: "{{ item.src }}"
      dest: "{{ item.dest }}"
      owner: root
      group: root
      mode: "{{ item.mode }}"
    with_items:
      - { src: "iptables_rules.ipv4", dest: "/etc/iptables/rules.v4", mode: "0644" }
   
```
Модуль template копирует файл, которые были указаны выше. Для файла уже установлен атрибут выполнения файла.  

Все действия выполняются в блоке, это нужно для того, чтобы в конце указать условие «Выполнять только на хосте inetRouter»

Первый модуль «iptables-persistent» устанавливает нам необходимые пакеты. Второй модуль копирует нам конфигурационный файл правил Iptables (который мы рассматривали в настройке NAT вручную). 

#### Маршрутизация транзитных пакетов (IP forward)

Важным этапом настройки сетевой лаборатории, является маршрутизация транзитных пакетов. Если объяснить простыми словами — это возможность сервера Linux пропускать трафик через себя к другому серверу. По умолчанию эта функция отключена в Linux.

Включить её можно командой:

```
sysctl net.ipv4.conf.all.forwarding=1
```

Посмотреть статус форвардинга можно командой:

```
root@inetRouter:~# sysctl net.ipv4.ip_forward
net.ipv4.ip_forward = 1
```

Если параметр равен 1, то маршрутизация транзитных пакетов включена, если 0 — отключена.

> В нашей схеме необходимо включить данную маршрутизацию на всех роутерах.
```
root@centralRouter:~# sysctl net.ipv4.ip_forward
net.ipv4.ip_forward = 1
...
root@office1Router:~# sysctl net.ipv4.ip_forward
net.ipv4.ip_forward = 1
...
root@office2Router:~# sysctl net.ipv4.ip_forward
net.ipv4.ip_forward = 1
```

#### Настройка маршрутизации транзитных пакетов с помощью Ansible

В Ansible есть специальный блок для внесений изменений в параметры ядра:

```bash
- name: set up forward packages across routers
  sysctl:
    name: net.ipv4.conf.all.forwarding
    value: '1'
    state: present
  when: "'routers' in group_names"
```

В условии указано, что изменения будут применяться только для группы «routers», группа routers создана в hosts-файле:

```
[routers]
inetRouter ansible_host=172.16.50.10 ansible_user=vagrant ansible_ssh_private_key_file=.vagrant/machines/inetRouter/virtualbox/private_key
centralRouter ansible_host=172.16.50.11 ansible_user=vagrant ansible_ssh_private_key_file=.vagrant/machines/centralRouter/virtualbox/private_key
office1Router ansible_host=172.16.50.20 ansible_user=vagrant ansible_ssh_private_key_file=.vagrant/machines/office1Router/virtualbox/private_key
office2Router ansible_host=172.16.50.30 ansible_user=vagrant ansible_ssh_private_key_file=.vagrant/machines/office2Router/virtualbox/private_key

[servers]
centralServer ansible_host=172.16.50.12 ansible_user=vagrant ansible_ssh_private_key_file=.vagrant/machines/inetRouter/virtualbox/private_key
office1Server ansible_host=172.16.50.21 ansible_user=vagrant ansible_ssh_private_key_file=.vagrant/machines/centralRouter/virtualbox/private_key
office2Server ansible_host=172.16.50.31 ansible_user=vagrant ansible_ssh_private_key_file=.vagrant/machines/office1Router/virtualbox/private_key
```

> Файл hosts — это файл инвентаризации, в нем указан список серверов, их адреса, группы и способы доступа на сервер.

#### Отключение маршрута по умолчанию на интерфейсе eth0 (в нашем случае enp0s3)

При разворачивании нашего стенда Vagrant создает в каждом сервере свой интерфейс, через который у сервера появляется доступ в интернет. Отключить данный порт нельзя, так как через него Vagrant подключается к серверам. Обычно маршрут по умолчанию прописан как раз на этот интерфейс, данный маршрут нужно отключить.

Для отключения дефолтного маршрута нужно в файле /etc/netplan/00-installer-config.yaml

```
# This is the network config written by 'subiquity'
network:
  ethernets:
    eth0:
      dhcp4: true
      dhcp4-overrides:
          use-routes: false
      dhcp6: false
  version: 2

```

После внесения данных изменений перезапускаем сетевую службу: 
netplan try

Отключение дефолтного маршрута требуется настроить на всех хостах кроме inetRouter

### Отключение маршрута по умолчанию с помощью Ansible

Для выполнения идентичных изменений с помощью Ansible, можно воспользоваться следующим блоком:
```
  - name: disable default route
    template: 
      src: 00-installer-config.yaml
      dest: /etc/netplan/00-installer-config.yaml
      owner: root
      group: root
      mode: 0644
    when: (ansible_hostname != "inetRouter") 
```

#### Настройка статических маршрутов

Для настройки статических маршрутов используется команда ip route. Данная команда работает в Debian-based и RHEL-based системах.

Давайте рассмотрим пример настройки статического маршрута на сервере office1Server. Исходя из схемы мы видим, что трафик с данного сервера будет идти через office1Router. Office1Server и office1Router у нас соединены через сеть managers (192.168.2.128/26). В статическом маршруте нужно указывать адрес следующего хоста. Таким образом мы должны указать на сервере office1Server маршрут, в котором доступ к любым IP-адресам у нас будет происходить через адрес 192.168.2.129, который расположен на сетевом интерфейсе office1Router. Команда будет выглядеть так: ip route add 0.0.0.0/0 via 192.168.2.129 

Посмотреть список всех маршрутов: ip route
```
root@office1Server:~# ip r
default via 10.0.2.2 dev enp0s3 proto dhcp src 10.0.2.15 metric 100 
10.0.2.0/24 dev enp0s3 proto kernel scope link src 10.0.2.15 metric 100 
10.0.2.2 dev enp0s3 proto dhcp scope link src 10.0.2.15 metric 100 
10.0.2.3 dev enp0s3 proto dhcp scope link src 10.0.2.15 metric 100 
172.16.2.128/26 dev enp0s8 proto kernel scope link src 172.16.2.130 
172.16.50.0/24 dev enp0s19 proto kernel scope link src 172.16.50.21 
root@office1Server:~#
```
  
Удалить маршрут: ip route del 0.0.0.0/0 via 172.16.2.129 

> Важно помнить, что маршруты, настроенные через команду ip route удаляются после перезагрузки или перезапуске сетевой службы.

Для того, чтобы маршруты сохранялись после перезагрузки нужно их указывать непосредственно в файле конфигурации сетевого интерфейса:

- В современных версиях Ubuntu, для указания маршрута нужно поправить netplan-конфиг. Конфиги netplan хранятся в виде YAML-файлов и обычно лежат в каталоге /etc netplan В нашем стенде такой файл - /etc/netplan/50-vagrant.yaml

Для добавления маршрута, после раздела addresses нужно добавить блок:

```
    enp0s8:
      addresses:
      - 192.168.2.130/26
     routes:
     - to: <сеть назначения>/<маска>
       via: <Next hop address>
```

Пример файла /etc/netplan/50-vagrant.yaml

```
---
network:
  version: 2
  renderer: networkd
  ethernets:
    eth1:
      addresses:
      - 192.168.2.130/26
      routes:
      - to: 0.0.0.0/0
        via: 192.168.2.129
    eth2:
      addresses:
      - 192.168.50.21/24
```

В YAML-файле очень важно следить за правильными отступами, ошибка в один пробел не даст сохранить изменения.

Применение изменений: 
```
root@office1Server:~# netplan try
Do you want to keep these settings?

Press ENTER before the timeout to accept the new configuration

Changes will revert in 120 seconds
Configuration accepted.
root@office1Server:~#
```

При настройке интерфейсов и маршрутов в любой из ОС можно оставлять комментарии в файле. Перед комментарием должен стоять знак «#»

Настройте самостоятельно все маршруты на серверах. Важно помнить, что помимо маршрутов по умолчанию, вам нужно будет использовать обратные маршруты. 

Давайте разберем пример такого маршрута: допустим мы хотим отправить команду ping с сервера office1Server (192.168.2.130) до сервера centralRouter (192.168.0.1) 
Наш трафик пойдёт следующим образом: office1Server — office1Router — centralRouter — office1Router — office1Server

Office1Router знает сеть (192.168.2.128/26), в которой располагается сервер office1Server, а сервер centralRouter, когда получит запрос от адреса 192.168.2.130 не будет понимать, куда отправить ответ. Решением этой проблемы будет добавление обратного маршрута. 

Обратный маршрут указывается также как остальные маршруты. Изучив схему мы видим, что связь между сетями 192.168.2.0/24 и 192.168.0.0/24 осуществляется через сеть 192.168.255.8/30. Также мы видим что сети office1 подключены к centralRouter через порт eth5. На основании этих данных мы можем добавить маршрут в файл /etc/netplan/50-vagrant.yaml
```
  ethernets:
    eth1:
      addresses:
      - 192.168.255.10/30
      routes:
      - to: 0.0.0.0/0
        via: 192.168.255.9
```



#### Настройка маршрутов с помощью Ansible

Для настройки маршрутов с помощью Ansible, нам необходимо подготовить файлы 50-vagrant.yaml с маршрутами для всех серверов. Далее с помощью модуля template мы можем их добавлять:
```
  - name: add default gateway for centralRouter
    template: 
      src: "50-vagrant_{{ansible_hostname}}.yaml"
      dest: /etc/netplan/50-vagrant.yaml
      owner: root
      group: root
      mode: 0644

  - name: restart all hosts
    reboot:
      reboot_timeout: 600
```
    
Для того, чтобы не писать 7 идентичных модулей, можно сделать один модуль, в котором будут перечисляться все хосты. Для этого у template-файлов должны быть идентичные имена формата 50-vagrant_<имя сервера>.yaml
Например:
![image](https://github.com/yurpv/lab_otus/assets/162872411/a3574d65-b800-4f46-bb36-72f6e10e89cf)


После копирования файлов, для применения сетевых настроек, перезагрузим все хосты 

Также модуль template позволяет использовать jinja2-шаблоны, с помощью которых файл может генериться автоматически, забирая информацию из данных о хосте (Ansible facts) и файлов переменных.

Более подробно про jinja2-шаблоны можно прочитать тут - <https://docs.ansible.com/ansible/2.9/user_guide/playbooks_templating.html>

На данном этапе настройка серверов закончена. После настройки серверов рекомендуется перезагрузить все хосты, чтобы проверить, что правила не удаляются после перезагрузки.

Помимо этого, рекомендуется на все хосты установить утилиту traceroute, которая ставится приразвертывании стенда.

Пример проверки выхода в Интернет через серверов:

```
root@inetRouter:~# traceroute 8.8.8.8
traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets
 1  _gateway (10.0.2.2)  0.203 ms  0.156 ms  0.147 ms
 2  192.168.0.1 (192.168.0.1)  3.755 ms  3.746 ms  3.703 ms
 3  fake-gw.maryno.net (81.88.208.255)  4.725 ms  5.954 ms  5.933 ms
 4  v223-nat3.maryno.net (188.244.0.60)  5.899 ms  5.886 ms  5.875 ms
 5  v224-c6509.maryno.net (188.244.0.65)  5.512 ms  5.605 ms *
 6  72.14.205.130 (72.14.205.130)  7.681 ms  4.482 ms  4.575 ms
 7  * * *
 8  72.14.239.130 (72.14.239.130)  4.909 ms 108.170.227.120 (108.170.227.120)  4.883 ms 108.170.227.70 (108.170.227.70)  6.155 ms
 9  192.178.241.146 (192.178.241.146)  5.550 ms 192.178.241.234 (192.178.241.234)  7.625 ms 108.170.250.51 (108.170.250.51)  5.764 ms
10  142.251.238.82 (142.251.238.82)  21.061 ms 142.250.238.214 (142.250.238.214)  23.321 ms 209.85.255.136 (209.85.255.136)  24.413 ms
11  142.250.233.0 (142.250.233.0)  23.070 ms 142.251.238.72 (142.251.238.72)  22.225 ms 142.250.235.62 (142.250.235.62)  20.369 ms
12  172.253.64.51 (172.253.64.51)  24.190 ms 216.239.42.21 (216.239.42.21)  22.456 ms 172.253.64.113 (172.253.64.113)  22.405 ms
13  * * *
14  * * *
15  * * *
16  * * *
17  * * *
18  * * *
19  * * *
20  * * *
21  * * *
22  dns.google (8.8.8.8)  19.832 ms  21.540 ms  21.399 ms
...
root@centralRouter:~# traceroute 8.8.8.8
traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets
 1  _gateway (192.168.255.1)  0.470 ms  0.433 ms  0.425 ms
 2  10.0.2.2 (10.0.2.2)  0.949 ms  0.942 ms  0.935 ms
 3  * * *
 4  fake-gw.maryno.net (81.88.208.255)  7.243 ms  7.235 ms  7.227 ms
 5  v223-nat3.maryno.net (188.244.0.60)  7.218 ms  7.164 ms  7.218 ms
 6  v224-c6509.maryno.net (188.244.0.65)  7.147 ms  5.748 ms  5.736 ms
 7  72.14.205.130 (72.14.205.130)  7.228 ms  6.653 ms  6.661 ms
 8  * * *
 9  72.14.232.44 (72.14.232.44)  6.690 ms 108.170.227.80 (108.170.227.80)  5.580 ms 172.253.69.168 (172.253.69.168)  6.658 ms
10  192.178.241.66 (192.178.241.66)  5.546 ms  5.538 ms 192.178.241.232 (192.178.241.232)  6.631 ms
11  172.253.66.116 (172.253.66.116)  24.790 ms 142.251.238.82 (142.251.238.82)  20.384 ms 216.239.51.32 (216.239.51.32)  21.305 ms
12  142.250.235.68 (142.250.235.68)  22.534 ms 142.251.237.144 (142.251.237.144)  19.322 ms 72.14.232.86 (72.14.232.86)  27.025 ms
13  216.239.58.53 (216.239.58.53)  20.382 ms 209.85.254.135 (209.85.254.135)  20.324 ms 142.250.56.221 (142.250.56.221)  23.488 ms
14  * * *
15  * * *
16  * * *
17  * * *
18  * * *
19  * * *
20  * * *
21  * * *
22  * * *
23  dns.google (8.8.8.8)  20.756 ms  23.301 ms  21.949 ms
...
root@centralServer:~# traceroute 8.8.8.8
traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets
 1  _gateway (192.168.0.1)  0.650 ms  0.598 ms  0.443 ms
 2  192.168.255.1 (192.168.255.1)  1.225 ms  1.233 ms  1.189 ms
 3  10.0.2.2 (10.0.2.2)  1.700 ms  1.535 ms  1.420 ms
 4  * * *
 5  * * *
 6  v223-nat3.maryno.net (188.244.0.60)  5.131 ms  3.685 ms  3.697 ms
 7  v224-c6509.maryno.net (188.244.0.65)  45.622 ms  5.402 ms  5.433 ms
 8  72.14.205.130 (72.14.205.130)  6.419 ms  4.988 ms  4.974 ms
 9  * * *
10  172.253.69.144 (172.253.69.144)  7.191 ms 108.170.226.246 (108.170.226.246)  7.183 ms 108.170.227.64 (108.170.227.64)  5.941 ms
11  192.178.241.148 (192.178.241.148)  7.168 ms  7.160 ms 192.178.241.66 (192.178.241.66)  7.696 ms
12  192.178.240.239 (192.178.240.239)  20.389 ms 72.14.234.54 (72.14.234.54)  20.381 ms 72.14.234.20 (72.14.234.20)  21.149 ms
13  142.251.238.66 (142.251.238.66)  29.335 ms 142.251.238.72 (142.251.238.72)  25.341 ms 108.170.232.251 (108.170.232.251)  24.354 ms
14  216.239.58.69 (216.239.58.69)  24.278 ms 108.170.233.163 (108.170.233.163)  22.711 ms 142.250.56.221 (142.250.56.221)  23.277 ms
15  * * *
16  * * *
17  * * *
18  * * *
19  * * *
20  * * *
21  * * *
22  * * *
23  * * *
24  dns.google (8.8.8.8)  19.713 ms  21.585 ms  22.629 ms
...
root@office1Router:~# traceroute 8.8.8.8
traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets
 1  _gateway (192.168.255.9)  0.749 ms  0.704 ms  0.419 ms
 2  192.168.255.1 (192.168.255.1)  1.206 ms  1.111 ms  1.072 ms
 3  10.0.2.2 (10.0.2.2)  2.396 ms  2.362 ms  2.198 ms
 4  * * *
 5  * * *
 6  v223-nat3.maryno.net (188.244.0.60)  5.851 ms  4.625 ms  4.609 ms
 7  v224-c6509.maryno.net (188.244.0.65)  4.703 ms  4.483 ms  4.448 ms
 8  72.14.205.130 (72.14.205.130)  5.838 ms  5.760 ms  5.686 ms
 9  * * *
10  108.170.227.68 (108.170.227.68)  6.216 ms 108.170.227.120 (108.170.227.120)  6.208 ms 108.170.226.90 (108.170.226.90)  6.201 ms
11  192.178.241.146 (192.178.241.146)  6.193 ms 108.170.250.34 (108.170.250.34)  6.528 ms *
12  192.178.240.241 (192.178.240.241)  18.404 ms 72.14.234.54 (72.14.234.54)  20.592 ms 209.85.249.158 (209.85.249.158)  27.073 ms
13  142.251.238.66 (142.251.238.66)  21.867 ms 72.14.232.86 (72.14.232.86)  22.587 ms 142.251.237.142 (142.251.237.142)  21.818 ms
14  209.85.251.63 (209.85.251.63)  23.740 ms 209.85.246.111 (209.85.246.111)  23.054 ms 142.250.232.179 (142.250.232.179)  20.325 ms
15  * * *
16  * * *
17  * * *
18  * * *
19  * * *
20  * * *
21  * * *
22  * * *
23  * * *
24  dns.google (8.8.8.8)  24.520 ms  20.284 ms  25.597 ms
...
root@office1Server:~# traceroute 8.8.8.8
traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets
 1  _gateway (192.168.2.129)  0.929 ms  0.844 ms  0.814 ms
 2  192.168.255.9 (192.168.255.9)  1.479 ms  1.586 ms  1.425 ms
 3  192.168.255.1 (192.168.255.1)  1.904 ms  1.777 ms  1.674 ms
 4  10.0.2.2 (10.0.2.2)  1.876 ms  1.831 ms  1.785 ms
 5  * * *
 6  * * *
 7  * * *
 8  v224-c6509.maryno.net (188.244.0.65)  5.176 ms  4.143 ms  4.128 ms
 9  72.14.205.130 (72.14.205.130)  5.303 ms  5.292 ms  5.188 ms
10  * * *
11  64.233.174.218 (64.233.174.218)  6.990 ms 108.170.226.160 (108.170.226.160)  6.980 ms 72.14.232.44 (72.14.232.44)  6.973 ms
12  108.170.250.34 (108.170.250.34)  7.036 ms  7.021 ms  5.854 ms
13  142.251.49.78 (142.251.49.78)  28.534 ms 142.251.238.82 (142.251.238.82)  28.528 ms 216.239.51.32 (216.239.51.32)  26.160 ms
14  108.170.235.204 (108.170.235.204)  26.147 ms 216.239.48.224 (216.239.48.224)  26.140 ms 142.250.235.74 (142.250.235.74)  23.792 ms
15  142.250.56.13 (142.250.56.13)  22.466 ms  22.457 ms 142.250.238.179 (142.250.238.179)  21.974 ms
16  * * *
17  * * *
18  * * *
19  * * *
20  * * *
21  * * *
22  * * *
23  * * *
24  * * *
25  dns.google (8.8.8.8)  24.255 ms  25.011 ms  23.427 ms
...
root@office2Router:~# traceroute 8.8.8.8
traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets
 1  _gateway (192.168.255.5)  0.274 ms  0.259 ms  0.235 ms
 2  192.168.255.1 (192.168.255.1)  0.394 ms  0.372 ms  0.330 ms
 3  10.0.2.2 (10.0.2.2)  0.427 ms  0.405 ms  0.384 ms
 4  * * *
 5  * * *
 6  v223-nat3.maryno.net (188.244.0.60)  5.389 ms  5.431 ms  5.349 ms
 7  v224-c6509.maryno.net (188.244.0.65)  10.128 ms  5.640 ms  5.588 ms
 8  * * *
 9  * * *
10  108.170.227.66 (108.170.227.66)  6.040 ms 172.253.69.160 (172.253.69.160)  8.901 ms 108.170.225.36 (108.170.225.36)  7.009 ms
11  192.178.241.146 (192.178.241.146)  8.822 ms 192.178.241.70 (192.178.241.70)  6.936 ms 192.178.241.66 (192.178.241.66)  5.918 ms
12  72.14.234.54 (72.14.234.54)  41.742 ms 142.251.238.82 (142.251.238.82)  19.920 ms 209.85.249.158 (209.85.249.158)  19.824 ms
13  108.170.232.251 (108.170.232.251)  23.545 ms 72.14.235.69 (72.14.235.69)  24.548 ms 72.14.232.76 (72.14.232.76)  23.504 ms
14  172.253.51.243 (172.253.51.243)  21.198 ms 142.250.209.161 (142.250.209.161)  24.518 ms 172.253.64.57 (172.253.64.57)  19.204 ms
15  * * *
16  * * *
17  * * *
18  * * *
19  * * *
20  * * *
21  * * *
22  * * *
23  * * *
24  dns.google (8.8.8.8)  20.583 ms  24.433 ms  19.856 ms
...
traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets
 1  _gateway (192.168.1.1)  0.899 ms  0.748 ms  0.711 ms
 2  192.168.255.5 (192.168.255.5)  1.315 ms  1.272 ms  1.238 ms
 3  192.168.255.1 (192.168.255.1)  1.971 ms  1.864 ms  1.820 ms
 4  10.0.2.2 (10.0.2.2)  2.167 ms  2.126 ms  1.979 ms
 5  * * *
 6  * * *
 7  * * *
 8  v224-c6509.maryno.net (188.244.0.65)  4.337 ms  4.921 ms  30.363 ms
 9  72.14.205.130 (72.14.205.130)  6.007 ms  5.981 ms  5.933 ms
10  * * *
11  108.170.227.78 (108.170.227.78)  5.833 ms 172.253.69.168 (172.253.69.168)  6.151 ms 72.14.233.92 (72.14.233.92)  7.322 ms
12  108.170.250.51 (108.170.250.51)  6.130 ms  6.097 ms 192.178.241.66 (192.178.241.66)  6.077 ms
13  209.85.249.158 (209.85.249.158)  32.814 ms 192.178.240.241 (192.178.240.241)  18.915 ms 209.85.249.158 (209.85.249.158)  32.092 ms
14  142.251.238.70 (142.251.238.70)  24.013 ms 216.239.48.224 (216.239.48.224)  21.583 ms 66.249.95.224 (66.249.95.224)  21.496 ms
15  142.250.56.15 (142.250.56.15)  21.331 ms 216.239.58.65 (216.239.58.65)  22.506 ms 172.253.79.237 (172.253.79.237)  22.480 ms
16  * * *
17  * * *
18  * * *
19  * * *
20  * * *
21  * * *
22  * * *
23  * * *
24  * * *
25  dns.google (8.8.8.8)  24.555 ms  23.913 ms  17.752 ms
```

В данном примере, в первых трёх переходах мы видим что запрос идёт через сервера: office1Router — centralRouter — inetRouter

Пример проверки доступности office1Server c хоста office2Server:

```
root@office1Server:~# traceroute 192.168.1.2
traceroute to 192.168.1.2 (192.168.1.2), 30 hops max, 60 byte packets
 1  _gateway (192.168.2.129)  1.006 ms  0.915 ms  0.879 ms
 2  192.168.255.9 (192.168.255.9)  1.523 ms  1.487 ms  1.397 ms
 3  192.168.255.6 (192.168.255.6)  1.528 ms  1.637 ms  1.506 ms
 4  192.168.1.2 (192.168.1.2)  2.236 ms  2.104 ms  2.088 ms
...
root@office2Server:~# traceroute 192.168.2.130
traceroute to 192.168.2.130 (192.168.2.130), 30 hops max, 60 byte packets
 1  _gateway (192.168.1.1)  0.557 ms  0.453 ms  0.555 ms
 2  192.168.255.5 (192.168.255.5)  0.946 ms  0.915 ms  0.889 ms
 3  192.168.255.10 (192.168.255.10)  1.644 ms  1.538 ms  1.434 ms
 4  192.168.2.130 (192.168.2.130)  1.590 ms  1.734 ms  1.662 ms
```

Для того, чтобы Ansible запускался сразу после развертывания серверов командой vagrant up, в текущий Vagrantfile нужно добавить блок запуска Ansible. Данный блок рекомендуется добавить после блока разворачивания виртуальных машин:

```
            if boxconfig[:vm_name] == "office2Server"
                box.vm.provision "ansible" do |ansible|
                    ansible.playbook = "ansible/provision.yml"
                    ansible.inventory_path = "ansible/hosts"
                    ansible.host_key_checking = "false"
                    ansible.limit = "all"
                end
            end
```

При добавлении блока Ansible в Vagrant, Ansible будет запускаться после создания каждой ВМ, это создат ошибку в разворачивании стенда и стенд не развернется. Для того, чтобы Ansible запустился после создания виртуальных машин, можно добавить условие, которое будет сравнивать имя виртуальной машины, и, когда условный оператор увидит имя последней созданной ВМ (office2Server), он запустит Ansible.

Разворачивание 7 виртуальных машин — процесс достаточно затраный для ресурсов компьютера. При разворачивании стенда с помощью Ansible иногда могут вылетать ошибки из-за сетевой связности. Это не страшно, после того как ВМ будут созданы, можно просто ещё раз запустить процесс настройки через ansible с помощью команды: vagrant provision.
